From 095e82f55bdacf7c2da88424c04d9ab64b267ccb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Joan=20Bruguera=20Mic=C3=B3?= <joanbrugueram@gmail.com>
Date: Sun, 7 Dec 2025 20:35:30 +0000
Subject: [PATCH 3/4] Fix compile for 6.19

[ naim: Change commit title and adapt it to nvidia 590 ]

Signed-off-by: Eric Naim <dnaim@cachyos.org>
---
 kernel-open/common/inc/nv-memdbg.h       |  5 +++--
 kernel-open/common/inc/nv-mm.h           |  9 +++++++++
 kernel-open/conftest.sh                  | 11 ++++++++++-
 kernel-open/nvidia-drm/nvidia-drm-priv.h |  3 +++
 kernel-open/nvidia/nv-dma.c              |  7 +++++++
 5 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/kernel-open/common/inc/nv-memdbg.h b/kernel-open/common/inc/nv-memdbg.h
index a7495710c4b4..66e539fe9697 100644
--- a/kernel-open/common/inc/nv-memdbg.h
+++ b/kernel-open/common/inc/nv-memdbg.h
@@ -41,8 +41,9 @@ void nv_memdbg_exit(void);
 
 #else
 
-#define NV_MEMDBG_ADD(ptr, size)
-#define NV_MEMDBG_REMOVE(ptr, size)
+// NB: Using while(0) to avoid -Wempty-body warnings
+#define NV_MEMDBG_ADD(ptr, size) while(0)
+#define NV_MEMDBG_REMOVE(ptr, size) while(0)
 
 #endif /* NV_MEM_LOGGER */
 
diff --git a/kernel-open/common/inc/nv-mm.h b/kernel-open/common/inc/nv-mm.h
index faeb84456a53..1c3ea311fae3 100644
--- a/kernel-open/common/inc/nv-mm.h
+++ b/kernel-open/common/inc/nv-mm.h
@@ -24,6 +24,7 @@
 #define __NV_MM_H__
 
 #include "conftest.h"
+#include <linux/version.h>
 
 #if !defined(NV_VM_FAULT_T_IS_PRESENT)
 typedef int vm_fault_t;
@@ -202,7 +203,11 @@ static inline void nv_vm_flags_set(struct vm_area_struct *vma, vm_flags_t flags)
 {
 #if !NV_CAN_CALL_VMA_START_WRITE
     nv_vma_start_write(vma);
+#if LINUX_VERSION_CODE < KERNEL_VERSION(6, 19, 0)
     ACCESS_PRIVATE(vma, __vm_flags) |= flags;
+#else
+    ACCESS_PRIVATE(&vma->flags, __vma_flags) |= flags;
+#endif
 #elif defined(NV_VM_AREA_STRUCT_HAS_CONST_VM_FLAGS)
     vm_flags_set(vma, flags);
 #else
@@ -214,7 +219,11 @@ static inline void nv_vm_flags_clear(struct vm_area_struct *vma, vm_flags_t flag
 {
 #if !NV_CAN_CALL_VMA_START_WRITE
     nv_vma_start_write(vma);
+#if LINUX_VERSION_CODE < KERNEL_VERSION(6, 19, 0)
     ACCESS_PRIVATE(vma, __vm_flags) &= ~flags;
+#else
+    ACCESS_PRIVATE(&vma->flags, __vma_flags) &= ~flags;
+#endif
 #elif defined(NV_VM_AREA_STRUCT_HAS_CONST_VM_FLAGS)
     vm_flags_clear(vma, flags);
 #else
diff --git a/kernel-open/conftest.sh b/kernel-open/conftest.sh
index 8e0736f08b2b..d43d31c74c68 100755
--- a/kernel-open/conftest.sh
+++ b/kernel-open/conftest.sh
@@ -215,6 +215,11 @@ build_cflags() {
             CFLAGS="$CFLAGS -mfentry -DCC_USING_FENTRY"
         fi
     fi
+
+    # Rel. commit "Kbuild: enable -fms-extensions" (Rasmus Villemoes, 20 Oct 2025)
+    # Enable the flags since the Linux headers use those extensions in some structs
+    # See https://www.phoronix.com/news/Linux-6.19-Patch-Would-MS-Ext
+    CFLAGS="$CFLAGS -fms-extensions"
 }
 
 CONFTEST_PREAMBLE="#include \"conftest/headers.h\"
@@ -3988,7 +3993,11 @@ compile_test() {
             CODE="
             #include <linux/mm_types.h>
             int conftest_vm_area_struct_has_const_vm_flags(void) {
-                return offsetof(struct vm_area_struct, __vm_flags);
+                // Rel. commit 'mm: introduce VMA flags bitmap type' (Lorenzo Stoakes, 14 Nov 2025)
+                // Check for the const-ness of vm_flags directly: If vm_flags
+                // is not const, _Generic doesn't match and the build fails)
+                struct vm_area_struct vma;
+                return _Generic(&vma.vm_flags, const typeof(vma.vm_flags) *: 1);
             }"
 
             compile_check_conftest "$CODE" "NV_VM_AREA_STRUCT_HAS_CONST_VM_FLAGS" "" "types"
diff --git a/kernel-open/nvidia-drm/nvidia-drm-priv.h b/kernel-open/nvidia-drm/nvidia-drm-priv.h
index 848012353558..9e18ec82f78c 100644
--- a/kernel-open/nvidia-drm/nvidia-drm-priv.h
+++ b/kernel-open/nvidia-drm/nvidia-drm-priv.h
@@ -35,6 +35,9 @@
 #include <drm/drm_device.h>
 #include <drm/drm_gem.h>
 
+// Rel. commit "drm/mm: replace drm_print.h include with a forward declaration" (Jani Nikula, 29 Oct 2025)
+#include <drm/drm_print.h>
+
 #include "nvidia-drm-os-interface.h"
 
 #include "nvkms-kapi.h"
diff --git a/kernel-open/nvidia/nv-dma.c b/kernel-open/nvidia/nv-dma.c
index 2984af848d5a..1e9a30de567d 100644
--- a/kernel-open/nvidia/nv-dma.c
+++ b/kernel-open/nvidia/nv-dma.c
@@ -26,6 +26,7 @@
 #include "os-interface.h"
 #include "nv-linux.h"
 #include "nv-reg.h"
+#include <linux/version.h>
 
 #define NV_DMA_DEV_PRINTF(debuglevel, dma_dev, format, ... )                \
     nv_printf(debuglevel, "NVRM: %s: " format,                              \
@@ -718,7 +719,13 @@ static NvBool nv_dma_use_map_resource
 #endif
     }
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 19, 0)
+    // Rel. commit "dma-mapping: remove unused mapping resource callbacks" (Leon Romanovsky, 15 Oct 2025)
+    // https://lore.kernel.org/all/20251015-remove-map-page-v5-0-3bbfe3a25cdf@kernel.org/
+    return (ops->map_phys != NULL);
+#else
     return (ops->map_resource != NULL);
+#endif
 }
 
 /* DMA-map a peer device's C2C aperture for peer access. */
-- 
2.52.0

